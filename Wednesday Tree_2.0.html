<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Luxury Interactive Christmas Tree</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <style>
        body { margin: 0; background: #050505; color: #fbcfe8; font-family: 'Georgia', serif; overflow: hidden; }
        canvas { display: block; }
        .gothic-blur { backdrop-filter: blur(12px); background: rgba(10, 10, 10, 0.85); border: 1px solid rgba(251, 207, 232, 0.2); }
        #video-container { position: absolute; bottom: 10px; right: 10px; width: 160px; height: 120px; border-radius: 8px; overflow: hidden; opacity: 0.6; border: 1px solid #fbcfe8; transform: scaleX(-1); z-index: 40;}
        #video-container video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="upload-overlay" class="absolute inset-0 z-50 flex items-center justify-center bg-[#050505]">
        <div class="gothic-blur p-10 rounded-[2.5rem] text-center max-w-md">
            <h1 class="text-3xl mb-6 tracking-widest uppercase">The Gothic Christmas</h1>
            <p id="status-msg" class="mb-8 text-pink-200/60 italic">Loading Ritual Components...</p>
            <div id="upload-box" class="hidden">
                <div class="flex justify-center gap-4 mb-8">
                    <input type="file" id="file-input" multiple accept="image/*" class="hidden">
                    <button onclick="document.getElementById('file-input').click()" class="px-8 py-3 border border-pink-300 text-pink-200 hover:bg-pink-900/30 transition-all rounded-full">
                        Choose 3 Photos
                    </button>
                </div>
                <div id="file-status" class="text-xs font-mono text-pink-500">0 / 3 UPLOADED</div>
            </div>
        </div>
    </div>

    <div id="card-overlay" class="hidden absolute inset-0 z-[60] flex items-center justify-center pointer-events-none">
        <div class="gothic-blur p-6 rounded-[2rem] w-80 shadow-[0_0_50px_rgba(236,72,153,0.2)] pointer-events-auto transform transition-transform" id="blessing-card">
            <div class="aspect-[3/4] bg-zinc-900 rounded-xl mb-4 overflow-hidden">
                <img id="card-img" src="" class="w-full h-full object-cover grayscale hover:grayscale-0 transition-all duration-700">
            </div>
            <p id="blessing-text" class="text-center italic text-pink-100 text-sm leading-relaxed"></p>
            <button onclick="closeCard()" class="mt-4 w-full py-2 text-xs uppercase tracking-tighter text-pink-400">Back to Void</button>
        </div>
    </div>

    <div id="video-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- 1. 状态管理与 MediaPipe 变量 ---
        let mode = 'FORMED';
        let uploadedImages = [];
        let handLandmarker = undefined;
        let lastVideoTime = -1;
        const video = document.getElementById("webcam");
        const blessings = [
            "Darkness is the canvas where stars shine brightest.",
            "A gothic heart finds beauty in the frosted shadows.",
            "May your night be silent, elegant, and mysterious.",
            "Eternal grace under the black star's light."
        ];

        // --- 2. 初始化手势识别 ---
        async function initHandTracking() {
            const vision = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
            );
            handLandmarker = await HandLandmarker.createFromOptions(vision, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`,
                    delegate: "GPU"
                },
                runningMode: "VIDEO",
                numHands: 1
            });
            
            // 启动摄像头
            const constraints = { video: { width: 1280, height: 720 } };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;

            document.getElementById('status-msg').innerText = "AI Ritual Ready. Upload Photos.";
            document.getElementById('upload-box').classList.remove('hidden');
        }

        // --- 3. 初始化 Three.js 场景 (保持原有逻辑) ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.02);
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 4, 20);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.2, 0.4, 0.85));

        const PARTICLE_COUNT = 8000;
        const positions = { chaos: new Float32Array(PARTICLE_COUNT * 3), tree: new Float32Array(PARTICLE_COUNT * 3) };
        const geometry = new THREE.BufferGeometry();
        const currentPosArray = new Float32Array(PARTICLE_COUNT * 3);
        
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const i3 = i * 3;
            // Chaos
            const r = 15 * Math.pow(Math.random(), 0.5);
            const theta = Math.random() * Math.PI * 2, phi = Math.acos(2 * Math.random() - 1);
            positions.chaos[i3] = r * Math.sin(phi) * Math.cos(theta);
            positions.chaos[i3+1] = r * Math.sin(phi) * Math.sin(theta);
            positions.chaos[i3+2] = r * Math.cos(phi);
            // Tree
            const h = Math.random() * 12;
            const radiusAtHeight = (1 - h / 12) * 5, angle = h * 2 + Math.random();
            positions.tree[i3] = Math.cos(angle) * radiusAtHeight;
            positions.tree[i3+1] = h - 6;
            positions.tree[i3+2] = Math.sin(angle) * radiusAtHeight;
        }
        geometry.setAttribute('position', new THREE.BufferAttribute(currentPosArray, 3));
        const points = new THREE.Points(geometry, new THREE.PointsMaterial({ size: 0.06, color: 0x111111, transparent: true, opacity: 0.8, blending: THREE.AdditiveBlending }));
        scene.add(points);

        const starGroup = new THREE.Group();
        starGroup.add(new THREE.Mesh(new THREE.OctahedronGeometry(0.8), new THREE.MeshBasicMaterial({ color: 0x000000 })));
        starGroup.add(new THREE.Mesh(new THREE.TorusGeometry(1.0, 0.02, 16, 100), new THREE.MeshBasicMaterial({ color: 0xFFD700 })));
        starGroup.position.y = 6.5;
        scene.add(starGroup);

        // --- 4. 实时交互主循环 ---
        let lerpFactor = 0, targetLerp = 0, handRotationOffset = 0;

        function animate() {
            requestAnimationFrame(animate);

            // 手势检测逻辑
            if (handLandmarker && video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                const results = handLandmarker.detectForVideo(video, performance.now());
                
                if (results.landmarks && results.landmarks.length > 0) {
                    const hand = results.landmarks[0];
                    // 判断张开 (8-食指, 12-中指, 16-无名指 是否高于 6, 10, 14 关节)
                    const isOpen = hand[8].y < hand[6].y && hand[12].y < hand[10].y;
                    mode = isOpen ? 'CHAOS' : 'FORMED';

                    // 横向位置控制旋转速度
                    handRotationOffset = (hand[9].x - 0.5) * 0.1;

                    // 捏合判断 (拇指 4 和 食指 8 距离)
                    const dist = Math.hypot(hand[8].x - hand[4].x, hand[8].y - hand[4].y);
                    if (dist < 0.05 && mode === 'FORMED') triggerCard();
                }
            }

            // 平滑插值
            targetLerp = (mode === 'CHAOS') ? 1 : 0;
            lerpFactor = THREE.MathUtils.lerp(lerpFactor, targetLerp, 0.05);

            const posAttr = geometry.attributes.position;
            for (let i = 0; i < PARTICLE_COUNT * 3; i++) {
                posAttr.array[i] = THREE.MathUtils.lerp(positions.tree[i], positions.chaos[i], lerpFactor);
            }
            posAttr.needsUpdate = true;

            points.rotation.y += 0.005 + handRotationOffset;
            starGroup.rotation.y -= 0.01;
            composer.render();
        }

        // --- 5. 辅助功能 ---
        function triggerCard() {
            const overlay = document.getElementById('card-overlay');
            if (overlay.classList.contains('hidden') && uploadedImages.length > 0) {
                document.getElementById('card-img').src = uploadedImages[Math.floor(Math.random()*uploadedImages.length)];
                document.getElementById('blessing-text').innerText = blessings[Math.floor(Math.random()*blessings.length)];
                overlay.classList.remove('hidden');
            }
        }

        window.closeCard = () => document.getElementById('card-overlay').classList.add('hidden');

        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files).slice(0, 3);
            uploadedImages = files.map(f => URL.createObjectURL(f));
            document.getElementById('file-status').innerText = `${uploadedImages.length} / 3 UPLOADED`;
            if (uploadedImages.length >= 1) {
                setTimeout(() => {
                    document.getElementById('upload-overlay').style.display = 'none';
                }, 800);
            }
        });

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });

        // 启动系统
        initHandTracking().then(() => animate());
    </script>
</body>
</html>